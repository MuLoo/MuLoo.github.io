<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>google浏览器插件 | 维罗妮卡号</title>
    <meta name="description" content="宁在一思进，莫在一思停">
    <link rel="icon" href="/logo.jpg">
  <link rel="apple-touch-icon" href="/photo.jpg">
    
    <link rel="preload" href="/assets/css/0.styles.f9e9789a.css" as="style"><link rel="preload" href="/assets/js/app.26acc76c.js" as="script"><link rel="preload" href="/assets/js/2.49a4b4c4.js" as="script"><link rel="preload" href="/assets/js/19.bf2d4e26.js" as="script"><link rel="prefetch" href="/assets/js/10.f20dac00.js"><link rel="prefetch" href="/assets/js/11.88265ad1.js"><link rel="prefetch" href="/assets/js/12.74c7234e.js"><link rel="prefetch" href="/assets/js/13.16a525a0.js"><link rel="prefetch" href="/assets/js/14.48ee6933.js"><link rel="prefetch" href="/assets/js/15.9738b4a3.js"><link rel="prefetch" href="/assets/js/16.2edb7d6f.js"><link rel="prefetch" href="/assets/js/17.282fb8eb.js"><link rel="prefetch" href="/assets/js/18.5d95a728.js"><link rel="prefetch" href="/assets/js/20.1c93c4bb.js"><link rel="prefetch" href="/assets/js/21.bcd9b58d.js"><link rel="prefetch" href="/assets/js/22.77a36d92.js"><link rel="prefetch" href="/assets/js/23.0f8682e6.js"><link rel="prefetch" href="/assets/js/24.ebb67184.js"><link rel="prefetch" href="/assets/js/25.16ebc4ba.js"><link rel="prefetch" href="/assets/js/26.7c36c41a.js"><link rel="prefetch" href="/assets/js/3.03a0d91b.js"><link rel="prefetch" href="/assets/js/4.85f08dfc.js"><link rel="prefetch" href="/assets/js/5.dcd707ba.js"><link rel="prefetch" href="/assets/js/6.08f0e26d.js"><link rel="prefetch" href="/assets/js/7.3bd1f663.js"><link rel="prefetch" href="/assets/js/8.5ecb18c1.js"><link rel="prefetch" href="/assets/js/9.da9f94dd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f9e9789a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container custom-page-class"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">维罗妮卡号</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/skill/" class="nav-link router-link-active">前端相关</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活随笔</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/skill/" class="nav-link router-link-active">前端相关</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活随笔</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>项目相关</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/skill/program/rotate-image.html" class="sidebar-link">图片旋转</a></li><li><a href="/skill/program/extension.html" class="active sidebar-link">google浏览器插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/skill/program/extension.html#google浏览器插件" class="sidebar-link">google浏览器插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/skill/program/extension.html#简单介绍" class="sidebar-link">简单介绍</a></li><li class="sidebar-sub-header"><a href="/skill/program/extension.html#前置知识" class="sidebar-link">前置知识</a></li><li class="sidebar-sub-header"><a href="/skill/program/extension.html#开发一个拓展" class="sidebar-link">开发一个拓展</a></li><li class="sidebar-sub-header"><a href="/skill/program/extension.html#实现部分" class="sidebar-link">实现部分</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="google浏览器插件"><a href="#google浏览器插件" aria-hidden="true" class="header-anchor">#</a> google浏览器插件</h2> <h3 id="简单介绍"><a href="#简单介绍" aria-hidden="true" class="header-anchor">#</a> 简单介绍</h3> <p><a href="https://crxdoc-zh.appspot.com/extensions/getstarted" target="_blank" rel="noopener noreferrer">中文文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p>扩展程序由一些文件（包括 HTML、CSS、JavaScript、图片以及其他任何您需要的文件）经过 zip 打包得到，为 Google Chrome 浏览器增加功能。<br>
扩展程序本质上是网页，它们可以利用浏览器为网页提供的所有 API，例如 XMLHttpRequest、JSON、HTML 5 等等。<br>
扩展程序可以通过内容脚本或跨站 XMLHttpRequest 与网页或者服务器交互，扩展程序也可以以编程方式与浏览器功能（例如书签和标签页交互）。</p></blockquote> <h3 id="前置知识"><a href="#前置知识" aria-hidden="true" class="header-anchor">#</a> 前置知识</h3> <p>每一个拓展程序包含以下文件：</p> <ul><li>一个清单文件</li> <li>一个或多个html文件</li> <li>可选: 一个或多个js文件</li> <li>可选: 拓展程序所需要的任何其他文件（图片等）</li></ul> <hr> <hr> <ul><li><a href="https://crxdoc-zh.appspot.com/extensions/manifest" target="_blank" rel="noopener noreferrer">清单文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
manifest.json，提供有关扩展程序的各种信息，例如最重要的文件和扩展程序可能具有的能力。</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;我的扩展程序&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;从 Google 获取信息。&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;icons&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;128&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon_128.png&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;persistent&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bg.js&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http://*.google.com/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://*.google.com/&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;browser_action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;default_title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;default_icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon_19.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;default_popup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;popup.html&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><a href="https://crxdoc-zh.appspot.com/extensions/background_pages" target="_blank" rel="noopener noreferrer">后台网页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
background.html 它是一个包含着拓展程序主要逻辑的不可见页面，当你在manifest.json中指定了background，就会有一个后台页面存在着。</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;background.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 与page二选一</span>
  <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token string">&quot;background.html&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 可以不指定</span>
  <span class="token property">&quot;persistet&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>scripts 和 page只需要指定一个。如果不指定page,只要有 background.js , 拓展也会自动生成一个background.html，引用这这个js。后台网页或者说background.js，可以看做整个拓展的幕后boss，他可以最先入场，最后退场，作为整个拓展的信息中心，跟拓展中各个页面或者脚本进行消息传递。</p> <ul><li><p><strong>用户界面</strong><br>
扩展程序可以包含普通的 HTML 网页，用来显示扩展程序的用户界面。<br>
常见的页面有，点击拓展弹出来的那个小弹窗，包含一些菜单或者设置，这就是一个html页面。<br>
另外的特殊页面是<a href="https://crxdoc-zh.appspot.com/extensions/override" target="_blank" rel="noopener noreferrer">替代页面<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，使用来自扩展程序中的 HTML 文件替换 Google Chrome 默认提供页面的方式。
最后，你可以使用 tabs.create 或 window.open() 来显示扩展程序中的任何其他 HTML 文件。
当然，你也可以使用 tabs.create 或 window.open() 来打开其他网站。</p></li> <li><p><a href="https://crxdoc-zh.appspot.com/extensions/content_scripts" target="_blank" rel="noopener noreferrer">内容脚本<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
content script可能是整个拓展里跟background.js同等重要的东西。所谓内容脚本，就是在网页的上下文中运行的js。
比如说某些拓展，它的功能是获取页面中的图片或者改变文字大小，那么这个拓展的内容脚本就需要注入到目标网站中，并在目标网站的上下文中运行。content script它可以通过标准的DOM来获取目标网页详情甚至改变网页DOM(这就提供了很多可能)。
如果说目标网页是你自己开发的话，content script甚至可以跟网页js通信，以达到更强大的效果。<br>
当然内容脚本不是万能的，它也由着一些使用上的限制。只可以调用部分api,不能使用所属扩展程序页面中定义的变量或函数，也不能使用网页或其他内容脚本中定义的变量或函数。<br>
总的来说，可以这么总结content script:</p> <ol><li>content script 应当视作网页的一部分，但contentScript与网页又是相互隔离的。即可以理解为content script是在一个特殊环境中运行的，这个环境成为isolated world（隔离环境）。</li> <li>content script 可以访问所注入页面的 DOM ,但是不能访问里面的任何 javascript 变量和函数。</li> <li>对每个 content script 来说，就像除了它自己之外再没有其它脚本在运行。 反过来也是成立的： 页面里的 javascript 也不能访问 content script 中的任何变量和函数。即使将参数直接赋值到 DOM 对象的属性上，只要不是 html 标准中定义的属性，就不能被另一个环境获取。</li></ol></li></ul> <h3 id="开发一个拓展"><a href="#开发一个拓展" aria-hidden="true" class="header-anchor">#</a> 开发一个拓展</h3> <h4 id="需求"><a href="#需求" aria-hidden="true" class="header-anchor">#</a> 需求</h4> <ol><li>假设这个拓展的主要作用是替代自己网站的登录、注册、忘记密码等功能。也就说，用户打开浏览器后自动弹出插件里的登录页面（或者注册、重置密码等），登录后关闭拓展页面跳到网站的登录后页面。</li> <li>如果用户从前登录过并信息没有失效，则直接跳转至网站登录后页面。</li> <li>用户从网站退出时，关闭网站页面，打开拓展里的登录页面。</li> <li>网站在遇到接口401的情况下，关闭网站页面，打开拓展里的登录页面。</li></ol> <p><em>这个需求可以很好的将background.js - contentScript - 网页之间的通信联系起来，完成后对拓展的工作方式有了较好的理解。</em></p> <p><strong>首先去繁就简来分析需求：</strong></p> <ol><li>这个拓展要替代网站的登录页面，那么拓展的默认popup.html就满足不了需求了，拓展得有自己的用户页面。在这个页面里进行操作交互，接口请求，然后成功后可以打开网站的某个页面。</li> <li>登录过就直接跳转，则需要使用拓展的存储功能。并且拓展需要将存储的登录凭证(token)传递给网页js，好让网页js能使用token进行接口校验。</li> <li>退出则关闭网站页面并打开拓展页面，则说明网站js和拓展之间要通信。注意这里是网站主动发起通信，而需求2是拓展主动发起的，这两者不一样。</li></ol> <p><strong>然后提炼实现这些需求里的技术要点：</strong></p> <blockquote><ol><li>拓展拥有一个登录的html， 至于是用纯html+js+css，还是使用框架然后打包成一个html都无所谓。拓展会默认加载popup.html,但是这个popup其实对用户来说是不存在的，只是作为跳板，打开我们真正需要的页面（login.html）。</li> <li>拓展要存储信息。拓展的存储有两种，一种是存储后随着chrome登录账户同步，一种是存储在浏览器本地（其他网页/拓展拿不到）。可以根据需求来使用哪种，本拓展使用本地存储就行了。</li> <li>除了存储，拓展还要把信息传递给网站的js。这里就需要拓展与网页的通信，background无法直接和网站js通信，但是可以和contentScript通信，而contentScript注入到网页页面，具备操作DOM的能力，这似乎就有了一条信息通路。</li> <li>网站还要可以主动传递信息给拓展。网站传递消息给拓展，有两种方式：如果你在manifest.json中指定了希望与之通信的网站域名，则本来不存在的chrome.runtime对象会被挂在网页的window上，可以使用这个对象里的消息传递API来传递。然后在拓展里使用对应的监听来接受消息。（注意只能网页主动发给拓展，拓展无法直接发给网页）。另外的方式就是通过contentScript作为桥梁沟通网页和background.js.</li></ol></blockquote> <p>上面的分析几乎没有API和代码，主要是为了厘清思路，知道了路的方向，怎么走就容易了。</p> <p>那么，开始上代码：</p> <h3 id="实现部分"><a href="#实现部分" aria-hidden="true" class="header-anchor">#</a> 实现部分</h3> <h4 id="首先是manifest-json"><a href="#首先是manifest-json" aria-hidden="true" class="header-anchor">#</a> 首先是manifest.json</h4> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;manifest_version&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome extension&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;icons&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;16&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon.png&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;48&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon.png&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;128&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon.png&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;background.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;persistet&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 允许直接发送消息给拓展的页面</span>
    <span class="token property">&quot;externally_connectable&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;matches&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http://www.xxxx.com/*&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 允许加载外部资源的地址</span>
    <span class="token property">&quot;web_accessible_resources&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;https://xxx.alicdn.com&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content_scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;matches&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http://www.xxxx.com/*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 内容脚本注入的目标网页</span>
          <span class="token property">&quot;js&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;contentScript.js&quot;</span> <span class="token comment">// 内容脚本</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;run_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;document_start&quot;</span> <span class="token comment">// 注入时机 document_start document_end document_idle(默认)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;options_page&quot;</span><span class="token operator">:</span> <span class="token string">&quot;login.html&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// 供openOptionsPage方法使用</span>
    <span class="token comment">// 拓展所拥有的权限</span>
    <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;tabs&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;storage&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;webRequest&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;http://*/*&quot;</span><span class="token punctuation">,</span>
		    <span class="token string">&quot;https://*/*&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 浏览器行为（工具栏拓展的图标，默认弹窗等）</span>
    <span class="token property">&quot;browser_action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;default_popup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;popup.html&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;default_icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon.png&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;default_title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xxx&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 引用外部资源的地址，否则无法通过scp。拓展的html同样有scp限制。</span>
    <span class="token property">&quot;content_security_policy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;script-src 'self' https://xxx.alicdn.com 'unsafe-eval';  object-src 'self'&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这份清单指定了background.js、contentScript、 目标页面，有了这三者，信息就可以传动起来了。</p> <p>那么接下来先看 background.js：</p> <h4 id="background-js"><a href="#background-js" aria-hidden="true" class="header-anchor">#</a> background.js</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> at <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// access token</span>
<span class="token keyword">let</span> rt <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// refresh token</span>
<span class="token keyword">let</span> first <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token comment">/**
* 当background.js 开始执行的时候，也就是浏览器打开的时候。如果没有登录信息，则直接打开登录页面
*/</span>
<span class="token keyword">function</span> <span class="token function">chromeStart</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  first <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">const</span> at <span class="token operator">=</span> window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'Access-Token'</span><span class="token punctuation">)</span> <span class="token comment">// 是否存储了登录信息，即判断是否曾经成功登录过</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>at<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     window<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> <span class="token string">'https://www.xxxx.com/abc'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 登录信息在，则直接跳去目标页面</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则打开登录页面。注意：这里的openOptionsPage方法需要先在manifest.json里指定 options_page</span>
    window<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">openOptionsPage</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'启动浏览器时打开新标签，新标签是拓展里的login.html'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 只在浏览器启动时执行一次</span>
<span class="token operator">!</span>first <span class="token operator">&amp;&amp;</span> <span class="token function">chromeStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/**
* background 接受由content script传递的信息
* @param function
* @returns {*}
*/</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'background 收到:'</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> sender<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      accessToken<span class="token punctuation">,</span>
      refreshToken<span class="token punctuation">,</span>
      injected<span class="token punctuation">,</span> <span class="token comment">// 表示content script已经注入网页</span>
      clear <span class="token comment">// 表示 网页401/退出登录，需要清除插件存储里的token</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> request
    <span class="token keyword">if</span> <span class="token punctuation">(</span>accessToken <span class="token operator">&amp;&amp;</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      at <span class="token operator">=</span> accessToken
      rt <span class="token operator">=</span> refreshToken
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>injected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 内容脚本已经注入，发送消息给内容脚本</span>
      <span class="token function">sendToContentScript</span><span class="token punctuation">(</span><span class="token punctuation">{</span> accessToken<span class="token punctuation">:</span> at<span class="token punctuation">,</span> refreshToken<span class="token punctuation">:</span> rt <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span> msg<span class="token punctuation">:</span> <span class="token string">'得知注入'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'Refresh-Token'</span><span class="token punctuation">)</span>
      window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'Access-Token'</span><span class="token punctuation">)</span>
      at <span class="token operator">=</span> <span class="token keyword">null</span>
      rt <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span> msg<span class="token punctuation">:</span> <span class="token string">'已经删除token'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// chrome.tabs.update({ url: `chrome-extension://${chrome.runtime.id}/login.html` })</span>
      chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>active<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> currentWindow<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tabs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tabs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 需要被关闭的标签页id</span>
          <span class="token keyword">const</span> tabIds <span class="token operator">=</span> tabs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span>url<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'www.xxxx.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              acc<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> acc
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tabIds ---'</span><span class="token punctuation">,</span> tabIds<span class="token punctuation">)</span>
          <span class="token comment">// 关闭当前活动的并且url是目标页面的标签页</span>
          chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>tabIds<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 打开拓展里的登录页</span>
      chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">openOptionsPage</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'打开新标签'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span> greeting<span class="token punctuation">:</span> <span class="token string">'从background返回给你'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">/**
* 将拓展登录页获取到的accessToken, refreshToken 传递给已注入网页的content script
* @param  { accessToken, refreshToken}
* @returns { * }
*/</span>
<span class="token keyword">function</span> <span class="token function">sendToContentScript</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  accessToken<span class="token punctuation">,</span>
  refreshToken
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'background在得知contentscript注入后执行'</span><span class="token punctuation">)</span>
  chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>active<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> currentWindow<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tabs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取当前的活动标签页，然后利用 chrome.tabs.sendMessage 将存储的登录信息传递给contentScript</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'活动的tabs:'</span><span class="token punctuation">,</span> tabs<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">&amp;&amp;</span> accessToken <span class="token operator">&amp;&amp;</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> accessToken<span class="token punctuation">,</span> refreshToken <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'background 收到：'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'不符合条件：'</span><span class="token punctuation">,</span> tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">,</span> refreshToken<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// // background 接收由网页端发送来的消息，只能被动接收，然后回应，不能主动发送消息给网页端</span>
<span class="token comment">// chrome.runtime.onMessageExternal.addListener(</span>
<span class="token comment">//   function(request, sender, sendResponse) {</span>
<span class="token comment">//     alert('收到了')</span>
<span class="token comment">//     sendResponse('还给你')</span>
<span class="token comment">//   }</span>
<span class="token comment">// )</span>
</code></pre></div><p>从background.js 中可以看到，它监听了来自contentScript的信息，根据contentScript里传递不同参数，来执行不同操作。同时它也发送了消息给contentScript，将登录信息告知。<br>
从前面可以知道，contentScript是要被注入到目标页面的，background -- contentScript -- 目标页面，可见contentScript作为桥梁的重要性。那么接下来看contentScript:</p> <h4 id="content-script"><a href="#content-script" aria-hidden="true" class="header-anchor">#</a> content script</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// content script 无法使用目标页面的变量、方法、window、 storage。 content script 与页面是相互独立的</span>
<span class="token comment">// 注入目标页面即开始执行</span>
<span class="token comment">// 通知background.js 已经注入页面</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>injected<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// background 得知注入，并返回信息</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 接收由background 发送过来的消息</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    accessToken<span class="token punctuation">,</span>
    refreshToken
  <span class="token punctuation">}</span> <span class="token operator">=</span> request
  <span class="token comment">// background传来了需要的信息，那么要想办法塞给目标页面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>accessToken <span class="token operator">&amp;&amp;</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> theScript <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token comment">// 利用script标签，存进目标页面的localStorage</span>
    theScript<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/javascript'</span>
    <span class="token keyword">const</span> stamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    theScript<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
        console.log('执行了')
        window.localStorage &amp;&amp; window.localStorage.setItem('Access-Token', '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">');
        window.localStorage &amp;&amp; window.localStorage.setItem('Refresh-Token', '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>refreshToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">');
    `</span></span>
    document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>theScript<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'theScript ----'</span><span class="token punctuation">,</span> theScript<span class="token punctuation">)</span>
    <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听来自网页端的消息 （401/logout）</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>source <span class="token operator">==</span> window <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token string">'401'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>clear<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// background 得知需要删除token后，并返回信息</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token string">'logout'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 退出登录了，拓展里的token也该清掉</span>
      chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> clear<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// background 得知需要删除token后，并返回信息</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>重要的三部分已经完成了，background 和 contentScript 已经可以互相通信。<br>
整个流程是：<br> <strong>拓展登录页 -&gt; 成功登录 -&gt; 告知background -&gt; background通知内容脚本并打开目标页面 -&gt; 内容脚本将信息嵌入目标页面 -&gt; 目标页面拿到信息成功登录</strong><br>
现在大部分的流程中间的流程已经通了，剩下的是头尾部分，头即在拓展的login.html里通知background.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 前面是登录接口验证等，在接口成功后</span>
<span class="token comment">// 通知background</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>accessToken<span class="token punctuation">,</span> refreshToken<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// background返回信息后</span>
  window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'Access-Token'</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span> <span class="token comment">// 登录信息存储在拓展的localStorage</span>
  window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'Refresh-Token'</span><span class="token punctuation">,</span> refreshToken<span class="token punctuation">)</span>
  window<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> <span class="token string">'https://www.xxxx.com/abc'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 打开目标页面</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>尾即在目标页面的某些时刻通知contentScript, 用的是postMessage</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  code<span class="token punctuation">:</span> <span class="token string">'logout'</span><span class="token punctuation">,</span>
  message<span class="token punctuation">:</span> <span class="token string">'logout'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  code<span class="token punctuation">:</span> <span class="token string">'401'</span><span class="token punctuation">,</span>
  message<span class="token punctuation">:</span> <span class="token string">'clearToken'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
</code></pre></div><p>至此，全部流程基本走完，其实看下来，关键点还是background和contentScript间的通信。
最后用一张流程图结尾吧：</p> <p><img src="https://pic.yupoo.com/leisurenana/1af36ec4/9d15d68f.png" alt="流程图"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新于: </span> <span class="time">8/29/2020, 12:15:13 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/skill/program/rotate-image.html" class="prev">
          图片旋转
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.26acc76c.js" defer></script><script src="/assets/js/2.49a4b4c4.js" defer></script><script src="/assets/js/19.bf2d4e26.js" defer></script>
  </body>
</html>
