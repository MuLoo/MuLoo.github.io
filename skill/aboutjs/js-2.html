<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>遇到的一些emmoji相关的问题 | 维罗妮卡号</title>
    <meta name="description" content="宁在一思进，莫在一思停">
    <link rel="icon" href="/logo.jpg">
  <link rel="apple-touch-icon" href="/photo.jpg">
    
    <link rel="preload" href="/assets/css/0.styles.f9e9789a.css" as="style"><link rel="preload" href="/assets/js/app.26acc76c.js" as="script"><link rel="preload" href="/assets/js/2.49a4b4c4.js" as="script"><link rel="preload" href="/assets/js/18.5d95a728.js" as="script"><link rel="prefetch" href="/assets/js/10.f20dac00.js"><link rel="prefetch" href="/assets/js/11.88265ad1.js"><link rel="prefetch" href="/assets/js/12.74c7234e.js"><link rel="prefetch" href="/assets/js/13.16a525a0.js"><link rel="prefetch" href="/assets/js/14.48ee6933.js"><link rel="prefetch" href="/assets/js/15.9738b4a3.js"><link rel="prefetch" href="/assets/js/16.2edb7d6f.js"><link rel="prefetch" href="/assets/js/17.282fb8eb.js"><link rel="prefetch" href="/assets/js/19.bf2d4e26.js"><link rel="prefetch" href="/assets/js/20.1c93c4bb.js"><link rel="prefetch" href="/assets/js/21.bcd9b58d.js"><link rel="prefetch" href="/assets/js/22.77a36d92.js"><link rel="prefetch" href="/assets/js/23.0f8682e6.js"><link rel="prefetch" href="/assets/js/24.ebb67184.js"><link rel="prefetch" href="/assets/js/25.16ebc4ba.js"><link rel="prefetch" href="/assets/js/26.7c36c41a.js"><link rel="prefetch" href="/assets/js/3.03a0d91b.js"><link rel="prefetch" href="/assets/js/4.85f08dfc.js"><link rel="prefetch" href="/assets/js/5.dcd707ba.js"><link rel="prefetch" href="/assets/js/6.08f0e26d.js"><link rel="prefetch" href="/assets/js/7.3bd1f663.js"><link rel="prefetch" href="/assets/js/8.5ecb18c1.js"><link rel="prefetch" href="/assets/js/9.da9f94dd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f9e9789a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">维罗妮卡号</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/skill/" class="nav-link router-link-active">前端相关</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活随笔</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/skill/" class="nav-link router-link-active">前端相关</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活随笔</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS相关</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/skill/aboutjs/js-1.html" class="sidebar-link">Daily-Interview-Question（节选）</a></li><li><a href="/skill/aboutjs/js-2.html" class="active sidebar-link">遇到的一些emmoji相关的问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/skill/aboutjs/js-2.html#遇到的一些emmoji相关的问题" class="sidebar-link">遇到的一些emmoji相关的问题</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目相关</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="遇到的一些emmoji相关的问题"><a href="#遇到的一些emmoji相关的问题" aria-hidden="true" class="header-anchor">#</a> 遇到的一些emmoji相关的问题</h2> <p>在项目里遇到一个问题，用户名里包含了emoji表情，但是个名字的展示长度是有限制的，超出部分用省略号代替</p> <h3 id="如果只是汉字、字母、数字"><a href="#如果只是汉字、字母、数字" aria-hidden="true" class="header-anchor">#</a> 如果只是汉字、字母、数字</h3> <p>先不考虑emoji的情况，那么一行 <code>测试test1234</code>的宽度该怎么算？
汉字占2个宽度，数字和字母占一个宽度，那么假设要求超过5个汉字的宽度就省略号展示，则：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">shortLongName</span> <span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">5</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> str
  <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> cutBegin <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token comment">// let cutEnd = 0;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> width <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> cutBegin <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cutBegin <span class="token operator">=</span> i
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token comment">// 单字节加1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> <span class="token number">0x0001</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token number">0x007e</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> <span class="token number">0xff60</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token number">0xff9f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      len<span class="token operator">++</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      len <span class="token operator">+=</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> cutBegin<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'...'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> str
<span class="token punctuation">}</span>

</code></pre></div><p>这里主要是<code>str.charCodeAt(i)</code>,得到这个汉字、数字、字母的unicode码，然后判断是在哪个区间，再加1个还是2个宽度就好了。</p> <h3 id="包含了emoji表情有什么不同"><a href="#包含了emoji表情有什么不同" aria-hidden="true" class="header-anchor">#</a> 包含了emoji表情有什么不同</h3> <p><code>😀 😁 😂 🤣 🤭 🧐 🤓 😈 👿 👹 👺 💀 👻 👽 🤖 💩 😺 😸 😹 😻 😼 😽 🙀 😿 😾👪 👨‍👩‍👧 👨‍👩‍👧‍👦 👨‍👩‍👦‍👨‍👩‍👧‍👧 👩‍👩‍👦 👩‍👩‍👧 👩‍👩‍👧‍👦 👩‍👩‍👦‍👦 👩‍👩‍👧‍👧👨‍👨‍👦 👨‍👨‍👧 👨‍👨‍👧‍👦 👨‍👨‍👦‍👦 👩‍👦 👩‍👧 👩‍👧‍👦 👩‍👦‍👦 👩‍👧‍👧 👨‍👦 👨‍👧 👨‍👧‍👦 👨‍👦‍👦</code></p> <p><code>&quot;😀&quot;.length</code> 是 2<br> <code>&quot;👨‍👩‍👧&quot;.length</code> 是 8<br> <code>&quot;👩‍👩‍👦‍👦&quot;.length</code> 是 11</p> <p>一个emoji表情应该也是属于一个字符，占据着Unicode的一个码点，但是为什么他们长度却不同</p> <blockquote><p>Unicode 包含一个系统，可以合并多个编码点，动态组合字符。此系统用各种方式增加灵活性，而不引起编码点的巨大组合膨胀。即组合字符
<a href="https://juejin.im/post/5c00b31a5188251d9e0c4a59" target="_blank" rel="noopener noreferrer">参考这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>总之，各个不同表情的length是不同的，想通过length来判断字符宽度是行不通了。
而且<code>👩‍👩‍👦‍👦</code>这个表情长度有11，如果随意切割了几位，页面上这个表情就无法正常显示，是个乱码符号。
那么就需要把<code>😀 😁 😂 👨‍👧‍👦 👨‍👦‍👦</code>都当做长度1（或2）的普通字符来计算真正的宽度</p> <p><a href="https://github.com/YingshanDeng/EmojiCharString" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是个判断emoji长度的工具，主要处理方式如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 处理包含emoji的字符串</span>
<span class="token keyword">const</span> astralRange <span class="token operator">=</span> <span class="token regex">/\ud83c[\udffb-\udfff](?=\ud83c[\udffb-\udfff])|(?:[^\ud800-\udfff][\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0]?|[\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff])[\ufe0e\ufe0f]?(?:[\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0]|\ud83c[\udffb-\udfff])?(?:\u200d(?:[^\ud800-\udfff]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff])[\ufe0e\ufe0f]?(?:[\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0]|\ud83c[\udffb-\udfff])?)*/g</span>
<span class="token keyword">class</span> <span class="token class-name">EmojiCharString</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> string <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Input must be a string'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_string <span class="token operator">=</span> string
    <span class="token keyword">this</span><span class="token punctuation">.</span>_match <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>astralRange<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">length</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_match<span class="token punctuation">.</span>length
  <span class="token punctuation">}</span>

  <span class="token function">toString</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_string
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Reverse the string in place
   * @return {[String]} [The reversed string]
   */</span>
  <span class="token function">reverse</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_match<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * The substring() method returns a subset of a string between begin index and end index
   * @param  {Number} begin [begin index]
   * @param  {Number} end   [end index]
   * @return {[String]}     [A new string containing the extracted section of the given string.]
   */</span>
  <span class="token function">substring</span> <span class="token punctuation">(</span><span class="token parameter">begin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> strLen <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length
    <span class="token keyword">let</span> indexStart <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> indexEnd
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> end <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      indexEnd <span class="token operator">=</span> strLen
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      indexEnd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexStart <span class="token operator">&gt;</span> strLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> indexStart <span class="token operator">=</span> strLen <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexEnd <span class="token operator">&gt;</span> strLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> indexEnd <span class="token operator">=</span> strLen <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexStart <span class="token operator">&gt;</span> indexEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>indexStart<span class="token punctuation">,</span> indexEnd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>indexEnd<span class="token punctuation">,</span> indexStart<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_match<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>indexStart<span class="token punctuation">,</span> indexEnd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * The substr() method return the characters in a string beginning at the specified location through the specified number of characters.
   * @param  {Number} begin [Location at which to begin extracting characters]
   * @param  {Number} len   [The number of characters to extract]
   * @return {[String]}     [A new string containing the extracted section of the given string]
   */</span>
  <span class="token function">substr</span> <span class="token punctuation">(</span><span class="token parameter">begin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> strLen <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length
    <span class="token keyword">let</span> indexStart <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token keyword">let</span> indexEnd
    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexStart <span class="token operator">&gt;=</span> strLen <span class="token operator">||</span> len <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">''</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>indexStart <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      indexStart <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> indexStart <span class="token operator">+</span> strLen<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> len <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      indexEnd <span class="token operator">=</span> strLen
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      indexEnd <span class="token operator">=</span> indexStart <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_match<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>indexStart<span class="token punctuation">,</span> indexEnd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>也是根据正则判断是否处于emoji的unicode范围
现在可以把每个emoji表情当做一个单位的字符来处理了，剩下的判断长度，超出截断就好做了。
大概步骤：</p> <ol><li>const str1 = new EmojiCharString(str) 处理一下</li> <li>如果str.length &lt; str1.length 说明有emoji表情</li> <li>对str1进行遍历,然后处理每个字符/汉字/emoji</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 包含emoji</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> emojiStr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">12</span> <span class="token operator">&amp;&amp;</span> cutBegin <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cutBegin <span class="token operator">=</span> i
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> char <span class="token operator">=</span> emojiStr<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 获取到具体的某个表情或者字符</span>
    <span class="token keyword">const</span> isEmoji <span class="token operator">=</span> char<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token comment">// emoji的length都是大于1的，而单个字母、汉字length为1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEmoji<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      len <span class="token operator">+=</span> char<span class="token punctuation">.</span>length
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> c <span class="token operator">=</span> char<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> <span class="token number">0x0001</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token number">0x007e</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> <span class="token number">0xff60</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token number">0xff9f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        len<span class="token operator">++</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        len <span class="token operator">+=</span> <span class="token number">2</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>剩下的就是判断len，超过限定的话，在cutBegin这里截断。注意这里的cutBegin是把emoji当一个长度处理后的起始位置。</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新于: </span> <span class="time">7/20/2019, 6:52:08 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/skill/aboutjs/js-1.html" class="prev">
          Daily-Interview-Question（节选）
        </a></span> <span class="next"><a href="/skill/tools/markdown.html">
          markdown所常用的一些语法
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.26acc76c.js" defer></script><script src="/assets/js/2.49a4b4c4.js" defer></script><script src="/assets/js/18.5d95a728.js" defer></script>
  </body>
</html>
